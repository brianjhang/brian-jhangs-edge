---
import { getLangFromUrl, useTranslations } from '../i18n';

interface Props {
  title?: string;
  category?: string;
}

const { title = '', category = '' } = Astro.props;
const currentLang = getLangFromUrl(Astro.url);
const t = useTranslations(currentLang);

// æ ¹æ“šæ–‡ç« é¡åˆ¥è¨­å®šä¸åŒçš„ category æ¨™è­˜
const giscusCategory = category ? `${category}-comments` : 'general';

// å¤šèªè¨€æ–‡æ¡ˆ
const commentsTitle = currentLang === 'en' ? 'ğŸ’¬ Discussion & Feedback' : 'ğŸ’¬ è¨è«–èˆ‡å›é¥‹';
const commentsDescription = currentLang === 'en'
  ? 'Welcome to share your thoughts or ask questions! This is a unified comment area where both Chinese and English comments are welcome.'
  : 'æ­¡è¿åœ¨ä¸‹æ–¹ç•™è¨€è¨è«–ï¼Œåˆ†äº«ä½ çš„æƒ³æ³•æˆ–æå‡ºå•é¡Œï¼é€™æ˜¯ä¸­è‹±æ–‡çµ±ä¸€çš„ç•™è¨€å€åŸŸï¼Œæ­¡è¿ä½¿ç”¨ä»»ä½•èªè¨€äº¤æµã€‚';
---

<div class="comments-section">
  <h3 class="comments-title">{commentsTitle}</h3>
  <p class="comments-description">{commentsDescription}</p>

  <div id="comments-container" data-lang={currentLang}>
    <!-- Giscus è©•è«–ç³»çµ±å°‡åœ¨é€™è£¡è¼‰å…¥ -->
  </div>
</div>

<script>
  // å‹•æ…‹è¼‰å…¥ Giscus è©•è«–ç³»çµ±
  function loadGiscus() {
    // æª¢æŸ¥æ˜¯å¦å·²ç¶“è¼‰å…¥é
    if (document.querySelector('#comments-container script')) {
      return;
    }

    // ç²å–ç•¶å‰èªè¨€è¨­å®š
    const container = document.getElementById('comments-container');
    if (!container) return;

    const currentLang = container.getAttribute('data-lang') || 'zh';
    const giscusLang = currentLang === 'en' ? 'en' : 'zh-TW';
    const loadingText = currentLang === 'en' ? 'Loading comments...' : 'è¼‰å…¥è©•è«–ç³»çµ±ä¸­...';

    // çµ±ä¸€è·¯å¾‘æ˜ å°„ï¼šä¸­è‹±æ–‡ç‰ˆä½¿ç”¨ç›¸åŒçš„ç•™è¨€å€åŸŸ
    let mappingPath = window.location.pathname;
    // å¦‚æœæ˜¯è‹±æ–‡ç‰ˆï¼Œç§»é™¤ /en å‰ç¶´ï¼Œæ˜ å°„åˆ°å°æ‡‰çš„ä¸­æ–‡ç‰ˆè·¯å¾‘
    if (mappingPath.startsWith('/en/')) {
      mappingPath = mappingPath.replace('/en/', '/');
    } else if (mappingPath === '/en') {
      mappingPath = '/';
    }

    // å‰µå»º Giscus script å…ƒç´ 
    const script = document.createElement('script');
    script.src = 'https://giscus.app/client.js';
    script.setAttribute('data-repo', 'brianjhang/brian-jhangs-edge');
    script.setAttribute('data-repo-id', 'R_kgDOPfo3Qg');
    script.setAttribute('data-category', 'Comments');
    script.setAttribute('data-category-id', 'DIC_kwDOPfo3Qs4CvtGO');
    script.setAttribute('data-mapping', 'specific');
    script.setAttribute('data-term', mappingPath);
    script.setAttribute('data-strict', '0');
    script.setAttribute('data-reactions-enabled', '1');
    script.setAttribute('data-emit-metadata', '0');
    script.setAttribute('data-input-position', 'top');
    script.setAttribute('data-theme', 'preferred_color_scheme');
    script.setAttribute('data-lang', giscusLang);
    script.setAttribute('data-loading', 'lazy');
    script.crossOrigin = 'anonymous';
    script.async = true;

    // æ›´æ–° loading æ–‡å­—
    const style = document.createElement('style');
    style.textContent = `
      #comments-container:empty::after {
        content: '${loadingText}';
      }
    `;
    document.head.appendChild(style);

    // å°‡ script æ’å…¥å®¹å™¨
    container.appendChild(script);
  }

  // é é¢è¼‰å…¥å¾Œåˆå§‹åŒ–
  document.addEventListener('DOMContentLoaded', loadGiscus);

  // æ”¯æ´ Astro çš„å®¢æˆ¶ç«¯è·¯ç”±
  document.addEventListener('astro:page-load', loadGiscus);
</script>

<style>
  .comments-section {
    margin-top: 48px;
    padding-top: 32px;
    border-top: 1px solid var(--border);
  }

  .comments-title {
    font-size: 1.5rem;
    font-weight: 600;
    color: var(--brand);
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .comments-description {
    color: var(--muted);
    font-size: 0.9rem;
    margin-bottom: 24px;
    line-height: 1.5;
  }

  #comments-container {
    min-height: 200px;
    position: relative;
  }

  /* Loading ç‹€æ…‹ */
  #comments-container:empty::after {
    content: 'è¼‰å…¥è©•è«–ç³»çµ±ä¸­...';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: var(--muted);
    font-size: 0.9rem;
  }

  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .comments-section {
      margin-top: 32px;
      padding-top: 24px;
    }

    .comments-title {
      font-size: 1.25rem;
    }
  }

  /* Giscus æ¨£å¼å®¢è£½åŒ– */
  :global(.giscus) {
    margin-top: 16px;
  }

  :global(.giscus-frame) {
    border-radius: 8px;
    border: 1px solid var(--border);
  }
</style>