---
import { getCollection } from 'astro:content';

export interface Props {
  currentSlug: string;
  currentCategory: 'ai' | 'crypto' | 'startup' | 'build';
  currentTags?: string[];
  maxItems?: number;
}

const { 
  currentSlug, 
  currentCategory, 
  currentTags = [], 
  maxItems = 3 
} = Astro.props;

// ç²å–åŒåˆ†é¡çš„æ‰€æœ‰æ–‡ç« 
const allPosts = await getCollection(currentCategory);

// éæ¿¾æ‰ç•¶å‰æ–‡ç« 
const otherPosts = allPosts.filter(post => post.slug !== currentSlug);

// è¨ˆç®—ç›¸é—œæ€§åˆ†æ•¸
const relatedPosts = otherPosts.map(post => {
  let score = 0;
  
  // æ¨™ç±¤åŒ¹é…åŠ åˆ†
  if (post.data.tags && currentTags.length > 0) {
    const matchingTags = post.data.tags.filter(tag => 
      currentTags.includes(tag)
    );
    score += matchingTags.length * 3;
  }
  
  // åŒå­åˆ†é¡åŠ åˆ†ï¼ˆé€šé slug åˆ¤æ–·ï¼‰
  const currentSubCategory = currentSlug.split('/')[0];
  const postSubCategory = post.slug.split('/')[0];
  if (currentSubCategory === postSubCategory) {
    score += 2;
  }
  
  // é›£åº¦ç­‰ç´šç›¸åŒåŠ åˆ†
  if (post.data.difficulty === currentCategory) {
    score += 1;
  }
  
  return { post, score };
}).sort((a, b) => b.score - a.score);

// ç²å–æ¨è–¦æ–‡ç« 
const recommendedPosts = relatedPosts.slice(0, maxItems);

// å¦‚æœç›¸é—œæ–‡ç« ä¸è¶³ï¼Œè£œå……æœ€æ–°æ–‡ç« 
if (recommendedPosts.length < maxItems) {
  const remainingCount = maxItems - recommendedPosts.length;
  const recentPosts = otherPosts
    .filter(post => !recommendedPosts.find(rp => rp.post.slug === post.slug))
    .sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime())
    .slice(0, remainingCount)
    .map(post => ({ post, score: 0 }));
  
  recommendedPosts.push(...recentPosts);
}

// åˆ†é¡ä¸»é¡Œé…ç½®
const categoryConfig = {
  ai: {
    title: 'AIå°ç™¾ç§‘',
    color: '#3b82f6',
    icon: 'ğŸ¤–',
    prefix: '/ai'
  },
  crypto: {
    title: 'å¹£åœˆç­†è¨˜',
    color: '#f59e0b',
    icon: 'ğŸ’',
    prefix: '/crypto'
  },
  startup: {
    title: 'å‰µæ¥­ç­†è¨˜',
    color: '#10b981',
    icon: 'ğŸš€',
    prefix: '/startup'
  },
  build: {
    title: 'å»ºè¨­æ—¥èªŒ',
    color: '#8b5cf6',
    icon: 'ğŸš§',
    prefix: '/build'
  }
};

const config = categoryConfig[currentCategory];

// ç”Ÿæˆæ–‡ç«  URL
function getPostUrl(post: any) {
  return `${config.prefix}/${post.slug}/`;
}

// æˆªå–æ¨™é¡Œ
function truncateTitle(title: string, maxLength = 60) {
  if (title.length <= maxLength) return title;
  return title.substring(0, maxLength) + '...';
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-TW', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
}
---

{recommendedPosts.length > 0 && (
  <section class="related-articles" aria-labelledby="related-heading">
    <div class="related-header">
      <h2 id="related-heading" class="related-title">
        <span class="related-icon">{config.icon}</span>
        ç›¸é—œ{config.title}
      </h2>
      <p class="related-subtitle">å»¶ä¼¸é–±è®€æ¨è–¦</p>
    </div>
    
    <div class="related-grid">
      {recommendedPosts.map(({ post, score }) => (
        <article class="related-card">
          <a href={getPostUrl(post)} class="related-link">
            <div class="related-content">
              <h3 class="related-card-title">
                {truncateTitle(post.data.title)}
              </h3>
              
              <p class="related-summary">
                {post.data.summary || post.data.description || 'æ·±å…¥äº†è§£ç›¸é—œä¸»é¡Œçš„å°ˆæ¥­çŸ¥è­˜èˆ‡å¯¦ç”¨æŠ€å·§'}
              </p>
              
              <div class="related-meta">
                <span class="related-date">
                  ğŸ“… {formatDate(post.data.date)}
                </span>
                
                {post.data.difficulty && (
                  <span class="related-difficulty">
                    {post.data.difficulty === 'beginner' ? 'å…¥é–€' : 
                     post.data.difficulty === 'intermediate' ? 'ä¸­éš' : 'é€²éš'}
                  </span>
                )}
                
                <span class="related-reading-time">
                  â±ï¸ {post.data.readingTime || 5} åˆ†é˜
                </span>
              </div>
              
              {post.data.tags && post.data.tags.length > 0 && (
                <div class="related-tags">
                  {post.data.tags.slice(0, 3).map(tag => (
                    <span class="related-tag">#{tag}</span>
                  ))}
                </div>
              )}
            </div>
            
            <div class="related-arrow">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                <path d="M7 17L17 7M17 7H7M17 7V17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            </div>
          </a>
        </article>
      ))}
    </div>
    
    <div class="related-footer">
      <a href={config.prefix} class="view-all-link">
        æŸ¥çœ‹æ‰€æœ‰{config.title} â†’
      </a>
    </div>
  </section>
)}

<style define:vars={{ categoryColor: config.color }}>
  .related-articles {
    margin: 64px 0 48px 0;
    padding: 32px 0;
    border-top: 1px solid var(--border);
  }
  
  .related-header {
    text-align: center;
    margin-bottom: 32px;
  }
  
  .related-title {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px;
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--brand);
    margin: 0 0 8px 0;
  }
  
  .related-icon {
    font-size: 1.5rem;
  }
  
  .related-subtitle {
    color: var(--muted);
    font-size: 1rem;
    margin: 0;
  }
  
  .related-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 24px;
    margin-bottom: 32px;
  }
  
  .related-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    overflow: hidden;
    transition: all 0.3s ease;
    height: 100%;
  }
  
  .related-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(0, 0, 0, 0.2);
    border-color: var(--categoryColor);
  }
  
  .related-link {
    display: flex;
    flex-direction: column;
    height: 100%;
    padding: 24px;
    text-decoration: none;
    color: inherit;
  }
  
  .related-content {
    flex: 1;
  }
  
  .related-card-title {
    font-size: 1.1rem;
    font-weight: 600;
    color: var(--brand);
    margin: 0 0 12px 0;
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .related-summary {
    color: var(--muted);
    font-size: 0.9rem;
    line-height: 1.6;
    margin: 0 0 16px 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
  
  .related-meta {
    display: flex;
    gap: 12px;
    margin-bottom: 12px;
    flex-wrap: wrap;
    align-items: center;
    font-size: 0.8rem;
    color: var(--muted);
  }
  
  .related-date {
    color: var(--muted);
  }
  
  .related-difficulty {
    background: var(--categoryColor);
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
  }
  
  .related-reading-time {
    color: var(--muted);
  }
  
  .related-tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  
  .related-tag {
    background: rgba(var(--categoryColor), 0.1);
    color: var(--categoryColor);
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 8px;
    border: 1px solid rgba(var(--categoryColor), 0.2);
  }
  
  .related-arrow {
    align-self: flex-end;
    margin-top: 16px;
    color: var(--categoryColor);
    opacity: 0.7;
    transition: all 0.2s ease;
  }
  
  .related-card:hover .related-arrow {
    opacity: 1;
    transform: translateX(4px);
  }
  
  .related-footer {
    text-align: center;
    padding-top: 24px;
    border-top: 1px solid var(--border);
  }
  
  .view-all-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--categoryColor);
    text-decoration: none;
    font-weight: 500;
    font-size: 1rem;
    padding: 12px 24px;
    border: 1px solid var(--categoryColor);
    border-radius: 8px;
    transition: all 0.2s ease;
  }
  
  .view-all-link:hover {
    background: var(--categoryColor);
    color: white;
    transform: translateY(-2px);
  }
  
  @media (max-width: 768px) {
    .related-articles {
      margin: 48px 0 32px 0;
      padding: 24px 0;
    }
    
    .related-grid {
      grid-template-columns: 1fr;
      gap: 16px;
    }
    
    .related-title {
      font-size: 1.5rem;
    }
    
    .related-link {
      padding: 20px;
    }
    
    .related-card-title {
      font-size: 1rem;
    }
    
    .related-summary {
      font-size: 0.85rem;
    }
    
    .related-meta {
      font-size: 0.75rem;
      gap: 8px;
    }
  }
</style>